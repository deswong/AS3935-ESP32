<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AS3935 Config</title>
  <style>
    :root{--primary:#0d47a1;--muted:#6b7280;--bg:#f6f8fb;--card:#fff}
    body{font-family:Inter,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:#111}
    header{background:linear-gradient(90deg,var(--primary),#1565c0);color:#fff;padding:12px 16px}
    main{max-width:980px;margin:16px auto;padding:12px}
    section.card{background:var(--card);border-radius:12px;padding:14px;margin-bottom:14px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9}
    button{background:var(--primary);color:#fff;border:none;padding:8px 12px;border-radius:8px}
    button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(13,71,161,0.12)}
  </style>
</head>
<body>
<header>
  <h1 style="font-size:18px;margin:0">AS3935 Config</h1>
</header>
<main>
  <section class="card">
    <h3 style="margin:0 0 8px 0">Wi-Fi</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div style="flex:1">
        <div class="label">SSID</div>
        <input id="wifi_ssid" type="text" placeholder="SSID">
      </div>
      <div style="flex:1">
        <div class="label">Password</div>
        <div style="display:flex;align-items:center;gap:8px">
          <input id="wifi_password" type="password" placeholder="Password" style="flex:1">
          <button id="wifi_pwd_toggle" class="ghost" title="Show/Hide password">üëÅ</button>
          <span id="wifi_pwd_badge" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>
      <div style="width:160px;display:flex;flex-direction:column;gap:6px">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="wifi_save" class="ghost">Save Wi-Fi</button>
          <button id="wifi_connect" class="ghost">Connect Now</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px 0">MQTT</h3>
    <div class="grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
      <div class="col">
        <div class="label">Broker URI</div>
        <input id="mqtt_uri" type="text" placeholder="mqtt://broker:1883 or mqtts://...">
      </div>
      <div class="col">
        <div class="label">Topic</div>
        <input id="mqtt_topic" type="text" placeholder="as3935/lightning">
      </div>
      <div class="col">
        <div class="label">Username</div>
        <input id="mqtt_username" type="text">
      </div>
      <div class="col">
        <div class="label">Password</div>
        <div style="display:flex;align-items:center;gap:8px">
          <input id="mqtt_password" type="password" placeholder="Password" style="flex:1">
          <button id="mqtt_pwd_toggle" class="ghost" title="Show/Hide password">üëÅ</button>
          <span id="mqtt_pwd_badge" style="font-size:12px;color:var(--muted)"></span>
        </div>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="mqtt_save" class="ghost">Save MQTT</button>
      <button id="mqtt_test" class="ghost">Test Publish</button>
    </div>
  </section>

</main>
<script>
(function(){
  async function jsonReq(u,o){ try{ const r = await fetch(u,o); if(!r.ok) return null; return await r.json(); }catch(e){return null;} }
  function setBadge(id,text){ const el = document.getElementById(id); if(el) el.innerText = text || ''; }
  function toggle(id){ const el=document.getElementById(id); if(!el) return; el.type = el.type==='password' ? 'text' : 'password'; }

  async function load(){
    const w = await jsonReq('/api/wifi/status');
    if(w){ document.getElementById('wifi_ssid').value = w.ssid||''; if(w.password_set){ document.getElementById('wifi_password').placeholder='saved (leave empty)'; setBadge('wifi_pwd_badge','saved'); }}
    const m = await jsonReq('/api/mqtt/status');
    if(m){ document.getElementById('mqtt_uri').value = m.uri||''; document.getElementById('mqtt_topic').value = m.topic||''; document.getElementById('mqtt_username').value = m.username||''; if(m.password_set){ document.getElementById('mqtt_password').placeholder='saved (leave empty)'; setBadge('mqtt_pwd_badge','saved'); }}
  }

  document.addEventListener('DOMContentLoaded', load);
  document.getElementById('wifi_pwd_toggle').addEventListener('click', ()=>toggle('wifi_password'));
  document.getElementById('mqtt_pwd_toggle').addEventListener('click', ()=>toggle('mqtt_password'));

  document.getElementById('wifi_save').addEventListener('click', async ()=>{
    const body = { ssid: document.getElementById('wifi_ssid').value };
    const pw = document.getElementById('wifi_password').value; if(pw && pw.length) body.password = pw;
    await fetch('/api/wifi/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  });

  document.getElementById('wifi_connect').addEventListener('click', async ()=>{
    const body = { ssid: document.getElementById('wifi_ssid').value };
    const pw = document.getElementById('wifi_password').value; if(pw && pw.length) body.password = pw; body.connect_now=true;
    await fetch('/api/wifi/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  });

  document.getElementById('mqtt_save').addEventListener('click', async ()=>{
    const body = { uri: document.getElementById('mqtt_uri').value, topic: document.getElementById('mqtt_topic').value, username: document.getElementById('mqtt_username').value };
    const pw = document.getElementById('mqtt_password').value; if(pw && pw.length) body.password = pw;
    await fetch('/api/mqtt/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    setBadge('mqtt_pwd_badge', pw && pw.length ? 'saved':'saved');
  });

  document.getElementById('mqtt_test').addEventListener('click', async ()=>{ await fetch('/api/mqtt/test',{method:'POST'}); });
})();
</script>
</body>
</html>
