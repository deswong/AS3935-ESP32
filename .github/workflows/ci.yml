name: CI Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Checkout ESP-IDF (v5.5.1)
      run: |
        # Clone esp-idf into the runner home so we can use its tools
        mkdir -p $HOME/esp
        if [ -d "$HOME/esp/esp-idf" ]; then echo "esp-idf already present"; else \
          git clone --depth 1 --branch v5.5.1 https://github.com/espressif/esp-idf.git $HOME/esp/esp-idf; fi

    - name: Vendor esp-cjson
      run: |
        # Clone esp-cjson into components so the component is available during build
        mkdir -p components
        if [ ! -d components/esp_cjson ]; then
          git clone --depth 1 https://github.com/espressif/esp-cjson.git components/esp_cjson
        else
          echo "components/esp_cjson already present"
        fi

    - name: Build (source esp-idf and build)
      run: |
        . $HOME/esp/esp-idf/export.sh
        idf.py set-target esp32c3
        idf.py build
